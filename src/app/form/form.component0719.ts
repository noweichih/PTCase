import { Component, OnInit, ViewChild, ElementRef/*, AfterViewInit*/ } from '@angular/core';
import { FormGroup } from '@angular/forms';
import { FormlyForm, FormlyFormBuilder, FormlyFormOptions, FormlyFieldConfig } from '@ngx-formly/core';
import { ActivatedRoute } from '@angular/router';
import { GlobalService } from '../global.service';
import { FormShape } from './form.model';
import { DataService } from './data.service';//FormService
//import { DataServ } from '../formly/dataservice';//FormService
import { CodeServ } from '../../service/data.codebook';//CodeBookService
//import { ReactiveFormsModule } from '@angular/forms';
//import { FormlyModule } from '@ngx-formly/core';
 
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { MatTabsModule } from '@angular/material/tabs';
//import { Injectable } from '@angular/core';
import { catchError, forkJoin, Observable, Observer, of } from 'rxjs';
import { map } from 'rxjs/operators';
interface FormObject { type: string, fieldGroup: []};
interface moreFormly extends FormlyFieldConfig {
  urlKey: number;
}
@Component({
  selector: 'app-form',
  styleUrls: ['./form.component.css', './form.formlycomponent.scss'],
  //styleUrls: ['./form.component.scss'],
  templateUrl: './form.component.html',
})
export class FormComponent implements OnInit{
  @ViewChild('myButton', { static: true }) myButton!: ElementRef<HTMLButtonElement>;
  form = new FormGroup({});  model: any = {};
  //model = {    ProtocolLink: { urlKey: 3 }  };
  options: FormlyFormOptions = {};  fields: moreFormly[] = [];//FieldConfig[] = [];
  appDocId: number = 0; // showYN: boolean = false;
  formTitle: string ='';
  formShap: FormShape[] = [];//ÈúÄË¶ÅËΩâÊèõdatamodel‰ª• ÈäúÊé•html
  //model.ProtocolLink.urlKey = '2000';
  constructor(
    private formService: DataService, private codeServ : CodeServ,//private CodeServ: DataServ,
    private route: ActivatedRoute,
    private myGlobal: GlobalService, 
    private fb: FormlyFormBuilder,
    private http: HttpClient ) {
      //this.options = { formState: { isButtonDisabled: true } }
    }
  onSubmit() { this.formdatasave(); 
  }
  onClickTest() { alert('Title clicked! to open another page');//Ê∏¨Ë©¶
  }

 //üíîüíîparsing formlyÁâ©‰ª∂ÂÖßÂÆπ:ÈáùÂ∞çselectÊ¨Ñ‰ΩçË™øÊï¥‰ª•Âèähyperlink
 //------------------------------------------------------------------------------
  async reform(theForm: any): Promise<any>{ //reform(theForm: any): Observable<any>{
    let param :string = ""; let i = -1; let ind1 = -1; //let ind0 = -1;  
    //alert('ÁúãÁúãreformË°®'+ JSON.stringify(theForm));
    for (const [tag0, val0] of Object.entries(theForm)) {//val0 Ë®≠ÂÆötabs
      //if (!(tag0 === 'type' && val0 === 'tabs')) { break; }//????Ëã•ÈñãÂÆóÊòéÁæ©Êú™Ê®ôtabpage Â∞±ÁÑ°Ê≥ïparsing
      if (tag0 === 'formTitle') {this.formTitle = JSON.stringify(val0);}//Ëá™Ë®ÇÁöÑË°®ÂñÆÂêçÁ®±ÊâÄÂú® tag0/val0
      if ((tag0 === 'fieldGroup') && (typeof val0 === 'object')) { //val0 : tabpage„Äås„Äç obj
        const tPagesobj = JSON.parse(JSON.stringify(val0));
        for (const onePageObj of tPagesobj) 
        {i++; alert( 'each Ê∑∑Ê≤åÁöÑpage „Äê'+ i +'„Äë\n\n'+ JSON.stringify(onePageObj));
        for (const [tag1, val1] of Object.entries(JSON.parse(JSON.stringify(onePageObj)))) {
          alert( 'each ÂêÑÈ†ÅÂ±¨ÊÄßÂåÖ:È†ÅÁ±§Âêç„ÄÅÊ¨Ñ‰ΩçÂ§ßÁµÑÂåÖÁ≠âÁ≠â=======\n\n'+ tag1 + '\n'+  JSON.stringify(val1));
          if (tag1 === 'fieldGroup')//focusÊ¨Ñ‰ΩçÂ§ßÁµÑÂåÖ
          { //alert('ÊàëÂè™Ë¶ÅÈ†Å‰πã‰∏ãÁöÑÊ¨Ñ‰ΩçÂ§ßÁµÑÂåÖ val1');
            let j = -1;
            const fieldset = JSON.parse(JSON.stringify(val1));
            for (const onefieldObj of fieldset) {//}} 
              j++;
            for (const [tag2, val2] of Object.entries(onefieldObj)) { ind1 = -1;
             //for (const [tag2, val2] of Object.entries(JSON.parse(JSON.stringify(val1)))) { ind1 = -1;
             //alert( 'ÊØèÊ¨Ñ‰ΩçÂ∞èÂåÖ‰∏≠ÁöÑÂ±¨ÊÄß=======\n\n'+ tag2 + '\n'+  JSON.stringify(val2));
             if (tag2 === 'templateOptions') {//alert( 'ÂÜçËêÉÂèñval2'); 
               let selOpt = false;
               for (let [tag3, val3] of Object.entries(JSON.parse(JSON.stringify(val2)))){
                 if (JSON.parse(JSON.stringify(val3)).substring(0, 9) === 'codebook(' ) {//Âèñ‰ª£Á¢ºË≥áÊñô
                   param = JSON.parse(JSON.stringify(val3));
                   param = param.substring(10, param.length -2); 
                   selOpt = true; break;  //break for-loop                      
                 }
               }
               if (selOpt===true){ //‰ª£Ë°®Ë©≤Ê¨Ñ‰ΩçË¶ÅÂ±ïÁèæ‰∏ãÊãâÈÅ∏È†Ö
                let dropItems = await this.codeServ.codebookitem(param);
                alert('Êñ∞Ê∏†ÈÅì codebook\n' + tag1 + ' / ' + tag2 +'\n'+ JSON.stringify(dropItems));
                theForm.fieldGroup[i].fieldGroup[j].templateOptions.options = dropItems;
                //alert(' ÂëºÂè´‰ª£Á¢ºÊúçÂãôÂÆåÊàê(type:'+ param +') ÂõûÊáâÈÅ∏È†ÖÁÇ∫\n'+ JSON.stringify(dropItems));
              }
             }
             //‰ª•‰∏ãÊòØËàäÁöÑË¶ÅÂæÄ‰∏äÊå™
            if (tag2 === 'fieldGroup') { //val2 : features inside one field
              
              for (const [tag3, val3] of Object.entries(JSON.parse(JSON.stringify(val2)))){
                ind1++;//Âç≥tag3?
                //alert('ÁõÆÂâçÁöÑÈ†ÅÁ±§/Ê¨Ñ‰Ωç '+tag1 + '/'+ tag3 +'('+ ind1 +')'+ val3);
                for (const [tag4, val4] of Object.entries(JSON.parse(JSON.stringify(val3)))){
                  //alert('Ë≥áÊñô '+ JSON.stringify(tag4)+ ' --- '+ JSON.stringify(val4));
                  //if(tag1 === '1'){alert('ËøΩÁ¥¢‰∏ÄÈ†Å:'+ tag3);}
                  if( typeof tag4 === 'string' && tag4.includes('type') &&
                      typeof val4 === 'string' && val4.includes('link')/* && tag4 === 'type'*/) { //for Ëá™Ë®ÇË°çÁîüÁöÑÈ°ûÂûã hyperlink
                    //alert('Êúâ‰∏ÄÂÄãhyperlink' + this.appDocId)
                    //alert('Âá∫ÁèæhyperlinkÁöÑÊ¨Ñ‰Ωç \n'+ JSON.stringify(val3));//tag4 +'(index??? '+ ind1 +')');
                    //this field.docID =this.appDocId)
                    theForm.fieldGroup[tag1].fieldGroup[tag3].templateOptions['docId'] = this.appDocId;
                  }
                  if(tag4 === 'templateOptions'){//tag4 stored field feature(tag)
                    let selOpt = false;
                    for (let [tag5, val5] of Object.entries(JSON.parse(JSON.stringify(val4)))){
                      if (JSON.parse(JSON.stringify(val5)).substring(0, 9) === 'codebook(' ) {
                        alert('ÂèñÈÅì codebook');
                        param = JSON.parse(JSON.stringify(val5));
                        param = param.substring(10, param.length -2); 
                        selOpt = true; break;  //break for-loop                      
                      }
                    }
                    if (selOpt===true){
                      let dropItems = await this.codeServ.codebookitem(param);
                      theForm.fieldGroup[tag1].fieldGroup[tag3].templateOptions.options = dropItems;
                      //alert(' ÂëºÂè´‰ª£Á¢ºÊúçÂãôÂÆåÊàê(type:'+ param +') ÂõûÊáâÈÅ∏È†ÖÁÇ∫\n'+ JSON.stringify(dropItems));
                    }
                  }

                } 
              }
            }
          } }}//alert('‰∏ãÂÄãÈ†Å' + (ind0+1));
        }}//end forLoop :tabPage[s] obj
      }

    }

    //alert(JSON.stringify('reformÂõûÂéª\n'+theForm));
    //return (theForm);
   
  }

 //----------------------------------------------------------
  ngOnInit(): void {//  ngAfterViewInit(): void {
    //const ucomp = this.myGlobal.GlobalVar.ucomp;//ÁÇ∫ÂÖçSQL injection
    const ucomp = 'QY00000001';
    let id: number = +this.route.snapshot.paramMap.get('docid')! || 0;
    this.appDocId = id;
    let pid = this.route.snapshot.paramMap.get('patternid');
    //alert('form component: ngInit show /comp: '+ ucomp +'/docid  '+ id+'  /pattern  ' + pid);
    this.myGlobal.GlobalVar.docid = id; //= {docid: id};//ËøΩÂä†docid as a global var.
    //alert('Ê∏¨Ë©¶global'+ this.myGlobal.GlobalVar.docid);
    this.formService.getformdata(ucomp, id).subscribe(
      docgot => {
        //1„ÄÅÂ±ïÈñãÁ©∫ÂñÆformpattern
        //alert('Ê†ºÂºèÊñáÊú¨  ' + JSON.stringify(docgot.formpattern));
        let formpattern = JSON.parse(JSON.stringify(docgot.formpattern));
        this.fields = [ formpattern ]; //ÂéüÊú¨ÈÄôÊ®£ÂØ´:Êú™ËôïÁêÜdropdownÂâçÁöÑÁ©∫ÂñÆÊ†ºÂºè
        this.reform(formpattern);
        this.fields[0].urlKey = id;//ÊåáÂÆöprotocolÁöÑÈÄ£Áµêkey
        //alert('ÂÖúÂá∫‰æÜÁöÑ\n' + JSON.stringify(this.fields));

        //üíîËß£ÊûêË°®ÂñÆÂêÑÈ†Ådropdown„ÄéÊ¨Ñ‰Ωç„Äèüíî

        //this.fields = [ formpattern ];//reset ng-formly form //this.fields = [ formpattern ]

        //2„ÄÅpatch or Êô∫ÊÖßÊåâÈàï(ÂÖÅË®±Êô∫ÊÖßÂ∏∂ÂÖ•)
        if (docgot.status === '0') { //alert('Â∏∂ÂÖ•')
          this.formService.formdeft(ucomp, id).subscribe(
            deftgot => {// ÂèñÂæóÊô∫ÊÖßÂª∫Ë≠∞Ë≥áÊñôÔºõalert(JSON.stringify(deftgot.deft));
              var len = JSON.stringify(deftgot.deft).length;
              if (len > 0)  {
                 this.model = deftgot.deft;
                 alert('ÂïüÂãï„ÄéÊô∫ÊÖßÂ∏∂ÂÖ•„ÄèÂäüËÉΩÔºå‰∏¶Â∑≤Â∞áÁõ∏ÈóúË≥áÊñôÂ∏∂ÂÖ•ÂêÑÊ¨Ñ‰Ωç!!');//Âà§Êñ∑null
            }
          })
        }
        else{//patch Êó©ÂÖàÁöÑÁï∞Âãï'
          //alert('Êó©ÂÖàÁöÑÁï∞ÂãïformData:'+ JSON.stringify(docgot.formData)); //alert('\nformData:'+ docgot.formpattern);
          //const formData = JSON.parse(docgot.formData);//XXX this.form.patchValue({"firstname":"ddd"}); (docgot.formData);
          this.model = docgot.formData;//‚òé‚òé‚òéÈáçË¶Å for UI updating (‚ú¶‚ú¶patchValueÁÑ°Ê≥ï‰ΩøÁî®)
      };
      },
      error => {
        console.log(error);
      }
    );

    //buttonControl = this.form.get('myButton');
    //this.buttonControl.disable();
    //this.myButton.nativeElement.disabled = true;
    //this.options.formState.isButtonDisabled = !this.form.valid;

  }
  //----------------------------------------------------------
  autodef(): void {//Êô∫ÊÖßÂ∏∂ÂÖ•
    //alert('auto default them')
  }
  //----------------------------------------------------------
  formdatasave(): void {//Áï∞ÂãïË≥áÊñôÂõûÂ≠ò
    let id: number = +this.route.snapshot.paramMap.get('docid')! || 0;
    const formdata:any  = this.form.value;// ÂèñÂæóË°®ÂñÆË≥áÊñô
    const jsondata = JSON.stringify(formdata);
    //alert('Áï∞ÂãïË≥áÊñô\n' + JSON.stringify(formdata))
    //this.formService.saveformdata(id, formdata).subscribe(
    this.formService.saveformdata(4, formdata).subscribe(
      docgot => {})
    alert('Ë®∫ÁôÇÁõ∏ÈóúÁ¥ÄÈåÑÁï∞ÂãïÂ∑≤ÂÑ≤Â≠ò!!');
  }
  
}